<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>beanstalk-client-ruby by kr</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>beanstalk-client-ruby</h1>
          <h2>Ruby client for beanstalkd</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/kr/beanstalk-client-ruby/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/kr/beanstalk-client-ruby/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/kr/beanstalk-client-ruby" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>Beanstalk Ruby Client</h1>

<p>Beanstalk is a simple, fast work queue. Its interface is generic, but was
originally designed for reducing the latency of page views in high-volume web
applications by running time-consuming tasks asynchronously.</p>

<h2>Installation</h2>

<p>Install beanstalk-client as a gem:</p>

<pre><code>gem install beanstalk-client
</code></pre>

<p>or add to your Gemfile:</p>

<div class="highlight"><pre><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'beanstalk-client'</span>
</pre></div>

<p>and run <code>bundle install</code> to install the dependency.</p>

<h2>Usage</h2>

<h3>Connection</h3>

<p>To interact with a beanstalk queue, first establish a client connection by providing host and port:</p>

<div class="highlight"><pre><span class="vi">@beanstalk</span> <span class="o">=</span> <span class="no">Beanstalk</span><span class="o">::</span><span class="no">Pool</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">'10.0.1.5:11300'</span><span class="o">]</span><span class="p">)</span>
</pre></div>

<h3>Tubes</h3>

<p>The system has one or more tubes which contain jobs. Each tube consists of a ready queue and a delay queue for jobs. 
When a client connects, its watch list is initially just the tube named <code>default</code>. 
If it submits jobs without having sent a <code>use</code> command, they will live in the tube named <code>default</code>.
You can specify the tube for a connection with:</p>

<div class="highlight"><pre><span class="vi">@beanstalk</span><span class="o">.</span><span class="n">use</span> <span class="s2">"some-tube-here"</span> <span class="c1"># 'default' if unspecified</span>
</pre></div>

<p>Tube names are at most 200 bytes. It specifies the tube to use. 
If the tube does not exist, it will be created.</p>

<h3>Jobs</h3>

<p>A job in beanstalk gets created by a client and includes a 'body' which con contain all relevant job metadata.
With BeanEater, a job is enqueued onto beanstalk and then later reserved and processed. 
Here is a picture of the typical job lifecycle:</p>

<pre><code>   put            reserve               delete
  -----&gt; [READY] ---------&gt; [RESERVED] --------&gt; *poof*
</code></pre>

<p>You can <code>put</code> a job onto the beanstalk queue using the <code>put</code> command:</p>

<div class="highlight"><pre><span class="vi">@beanstalk</span><span class="o">.</span><span class="n">put</span> <span class="s2">"job-data-here"</span>
</pre></div>

<p>You can also specify additional metadata to control job processing parameters. Specifically,
you can set the <code>priority</code>, <code>delay</code>, and <code>ttr</code> of a particular job:</p>

<div class="highlight"><pre><span class="c1"># defaults are priority 0, delay of 0 and ttr of 120 seconds</span>
<span class="vi">@beanstalk</span><span class="o">.</span><span class="n">put</span> <span class="s2">"job-data-here"</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span>
</pre></div>

<p>The <code>priority</code> argument is an integer &lt; 2**32. Jobs with a smaller priority take precedence over jobs with larger priorities. 
The <code>delay</code> argument is an integer number of seconds to wait before putting the job in the ready queue.
The <code>ttr</code> argument is the time to run -- is an integer number of seconds to allow a worker to run this job. </p>

<h3>Processing Jobs</h3>

<p>In order to process jobs, the worker first needs to specify which tubes to <code>watch</code> for new jobs:</p>

<div class="highlight"><pre><span class="vi">@beanstalk</span> <span class="o">=</span> <span class="no">Beanstalk</span><span class="o">::</span><span class="no">Pool</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">'10.0.1.5:11300'</span><span class="o">]</span><span class="p">)</span>
<span class="vi">@beanstalk</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="s1">'some-tube-name'</span><span class="p">)</span>
<span class="vi">@beanstalk</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="s1">'some-other-tune'</span><span class="p">)</span>
</pre></div>

<p>and perhaps even which tubes to <code>ignore</code> (including 'default'):</p>

<div class="highlight"><pre><span class="vi">@beanstalk</span><span class="o">.</span><span class="n">ignore</span><span class="p">(</span><span class="s1">'default'</span><span class="p">)</span>
</pre></div>

<p>and then we can begin to <code>reserve</code> jobs. This will find the first job available and 
return the job for processing: </p>

<div class="highlight"><pre><span class="n">job</span> <span class="o">=</span> <span class="vi">@beanstalk</span><span class="o">.</span><span class="n">reserve</span>
<span class="c1"># =&gt; &lt;Beanstalk::Job&gt;</span>
<span class="nb">puts</span> <span class="n">job</span><span class="o">.</span><span class="n">body</span>
<span class="c1"># prints 'job-data-here'</span>
</pre></div>

<p>You can process each new job as they become available using a loop:</p>

<div class="highlight"><pre><span class="kp">loop</span> <span class="k">do</span>
  <span class="n">job</span> <span class="o">=</span> <span class="n">beanstalk</span><span class="o">.</span><span class="n">reserve</span> <span class="c1"># waits for a job</span>
  <span class="nb">puts</span> <span class="n">job</span><span class="o">.</span><span class="n">body</span> <span class="c1"># prints "hello"</span>
  <span class="n">job</span><span class="o">.</span><span class="n">delete</span> <span class="c1"># remove job after processing</span>
<span class="k">end</span>
</pre></div>

<p>Beanstalk jobs can also be buried if they fail, rather than deleted:</p>

<div class="highlight"><pre><span class="n">job</span> <span class="o">=</span> <span class="vi">@beanstalk</span><span class="o">.</span><span class="n">reserve</span>
<span class="c1"># ...job fails...</span>
<span class="n">job</span><span class="o">.</span><span class="n">bury</span>
</pre></div>

<p>Burying a job means that the job is pulled out of the 
queue into a special 'holding' area for later inspection or reuse.</p>

<h3>Stats</h3>

<p>Beanstalk has plenty of commands for introspecting the state of the queues and jobs. These methods include:</p>

<div class="highlight"><pre><span class="c1"># Get overall stats about the state of beanstalk and processing that has occured</span>
<span class="vi">@beanstalk</span><span class="o">.</span><span class="n">stats</span>

<span class="c1"># Get statistical information about the specified job if it exists</span>
<span class="vi">@beanstalk</span><span class="o">.</span><span class="n">job_stats</span><span class="p">(</span><span class="n">some_job_id</span><span class="p">)</span>

<span class="c1"># Get statistical information about the specified tube if it exists</span>
<span class="vi">@beanstalk</span><span class="o">.</span><span class="n">stats_tube</span><span class="p">(</span><span class="n">some_tube_name</span><span class="p">)</span>

<span class="c1"># The list-tubes command returns a list of all existing tubes</span>
<span class="vi">@beanstalk</span><span class="o">.</span><span class="n">list_tubes</span>

<span class="c1"># Returns the tube currently being used by the client</span>
<span class="vi">@beanstalk</span><span class="o">.</span><span class="n">list_tube_used</span>

<span class="c1"># Returns a list tubes currently being watched by the client</span>
<span class="vi">@beanstalk</span><span class="o">.</span><span class="n">list_tubes_watched</span>
</pre></div>

<p>Be sure to check the <a href="http://github.com/kr/beanstalkd/raw/master/doc/protocol.txt">beanstalk protocol</a> file for
a more detailed looks at stats commands.</p>

<h2>Resources</h2>

<p>There are other resources helpful when learning about beanstalk:</p>

<ul>
<li><a href="http://kr.github.com/beanstalkd/">Beanstalkd homepage</a></li>
<li><a href="https://github.com/kr/beanstalk-client-ruby">beanstalk-ruby-client</a></li>
<li><a href="http://github.com/kr/beanstalkd/raw/master/doc/protocol.txt">beanstalk protocol</a></li>
</ul><h2>Contributors</h2>

<ul>
<li>Isaac Feliu</li>
<li>Peter Kieltyka</li>
<li>Martyn Loughran</li>
<li>Dustin Sallings</li>
</ul>
        </section>

        <footer>
          beanstalk-client-ruby is maintained by <a href="https://github.com/kr">kr</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>